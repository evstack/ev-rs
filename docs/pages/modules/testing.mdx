# Testing

Evolve supports three practical testing layers:

1. Unit tests against `MockEnv` for module logic.
2. Integration tests with `SimTestApp` for transaction/block behavior.
3. Deterministic simulation with `evolve_simulator` backends and reproducible seeds.

## Unit Testing with MockEnv

```rust
use evolve_core::{AccountId, Environment};
use evolve_testing::MockEnv;

#[test]
fn test_basic_operation() {
    let contract_id = AccountId::new(1);
    let sender_id = AccountId::new(100);
    let mut env = MockEnv::new(contract_id, sender_id);

    let module = MyModule::default();
    module.initialize(42, &mut env).expect("init failed");

    let result = module.increment(&mut env).expect("increment failed");
    assert_eq!(result, 43);
}
```

## Integration Testing with SimTestApp

`SimTestApp` is the integration harness used by `testapp` tests.

```rust
use evolve_simulator::SimConfig;
use evolve_testapp::sim_testing::SimTestApp;

#[test]
fn test_block_flow() {
    let mut app = SimTestApp::with_config(
        SimConfig {
            max_txs_per_block: 50,
            ..SimConfig::default()
        },
        42, // deterministic seed
    );

    let accounts = app.accounts();
    app.mint_atom(accounts.alice, 1_000);

    let result = app.submit_transfer_and_produce_block(
        accounts.alice,
        accounts.bob,
        100,
        100_000,
    );

    assert!(result.tx_results[0].response.is_ok());
}
```

## Simulator Storage Backends

The simulator can run against different storage implementations without changing test code.

```bash
# Mock storage backend (default)
export EVOLVE_SIM_STORAGE_MODE=mock

# QMDB backend (path optional; defaults under /tmp when unset)
export EVOLVE_SIM_STORAGE_MODE=qmdb
export EVOLVE_SIM_QMDB_PATH=/tmp/evolve-sim-qmdb
```

Then construct with:

```rust
let config = SimConfig::default().with_storage_backend_from_env();
let app = SimTestApp::with_config(config, 42);
```

## Shared STF Harness Helpers

`evolve_simulator` provides reusable helpers for execute+commit flow:

- `system_exec_genesis_and_commit`
- `system_exec_as_and_commit`
- `apply_block_and_commit`
- `query_stf`
- `run_block_iterations`

Use these to avoid duplicating storage/view/commit orchestration in test harnesses.

## Determinism Best Practices

1. Always pin a seed (`SimTestApp::with_config(..., seed)`).
2. Keep block workload bounded (`max_txs_per_block`).
3. Assert invariants over many blocks (supply conservation, no failed-tx state mutation).
4. Run the same scenario under multiple backends (`mock`, `qmdb`) when storage behavior matters.
